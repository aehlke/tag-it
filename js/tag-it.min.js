!function(t){t.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null},_create:function(){var e=this;this.element.is("input")?(this.tagList=t("<ul></ul>").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.addClass("tagit-hidden-field")):this.tagList=this.element.find("ul, ol").andSelf().last(),this.tagInput=t('<input type="text" data-item_value=""/>').addClass("ui-widget-content"),this.options.readOnly&&this.tagInput.attr("disabled","disabled"),this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex),this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText),this.options.autocomplete.source||(this.options.autocomplete.source=function(e,i){var a=e.term.toLowerCase(),s=t.grep(this.options.availableTags,function(t){return 0===t.toLowerCase().indexOf(a)});this.options.allowDuplicates||(s=this._subtractArray(s,this.assignedTags())),i(s)}),this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(){e._showAutocomplete()}),"undefined"==typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0)),t.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=t.proxy(this.options.autocomplete.source,this)),t.isFunction(this.options.tagSource)&&(this.options.tagSource=t.proxy(this.options.tagSource,this)),this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(t('<li class="tagit-new"></li>').append(this.tagInput)).click(function(i){var a=t(i.target);if(a.hasClass("tagit-label")){var s=a.closest(".tagit-choice");s.hasClass("removed")||e._trigger("onTagClicked",i,{tag:s,tagLabel:e.tagLabel(s)})}else e.tagInput.focus()});var i=!1;if(this.options.singleField)if(this.options.singleFieldNode){var a=t(this.options.singleFieldNode),s=a.val().split(this.options.singleFieldDelimiter);a.val(""),t.each(s,function(t,a){var s=a.split(":")[0],n=a.split(":")[1];e.createTag(s,n,null,!0),i=!0})}else this.options.singleFieldNode=t('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />'),this.tagList.after(this.options.singleFieldNode);if(i||this.tagList.children("li").each(function(){if(!t(this).hasClass("tagit-new")){var i=t(this).children("input:hidden").val().split(":")[0],i=t(this).children("input:hidden").val().split(":")[1];e.createTag(i,lbl,t(this).attr("class"),!0)}}),this.tagInput.keydown(function(i){if(i.which==t.ui.keyCode.BACKSPACE&&""===e.tagInput.val()){var a=e._lastTag();!e.options.removeConfirmation||a.hasClass("remove")?e.removeTag(a):e.options.removeConfirmation&&a.addClass("remove ui-state-highlight")}else e.options.removeConfirmation&&e._lastTag().removeClass("remove ui-state-highlight");(i.which===t.ui.keyCode.COMMA&&i.shiftKey===!1||i.which===t.ui.keyCode.ENTER||i.which==t.ui.keyCode.TAB&&""!==e.tagInput.val()||i.which==t.ui.keyCode.SPACE&&e.options.allowSpaces!==!0&&('"'!=t.trim(e.tagInput.val()).replace(/^s*/,"").charAt(0)||'"'==t.trim(e.tagInput.val()).charAt(0)&&'"'==t.trim(e.tagInput.val()).charAt(t.trim(e.tagInput.val()).length-1)&&t.trim(e.tagInput.val()).length-1!==0))&&((i.which!==t.ui.keyCode.ENTER||""!==e.tagInput.val())&&i.preventDefault(),e.options.autocomplete.autoFocus&&e.tagInput.data("autocomplete-open")||(e.tagInput.autocomplete("close"),e.createTag(e._cleanedItemValue(),e._cleanedInput())))}).blur(function(){e.tagInput.autocomplete("close"),t(this).val("")}),this.options.availableTags||this.options.tagSource||this.options.autocomplete.source){var n={select:function(t,i){return e.createTag(i.item.value,i.item.label),!1},focus:function(e,i){return t(this).val(i.item.label),t(this).data("item_value",i.item.value),!1}};t.extend(n,this.options.autocomplete),n.source=this.options.tagSource||n.source,this.tagInput.autocomplete(n).bind("autocompleteopen.tagit",function(){e.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose.tagit",function(){e.tagInput.data("autocomplete-open",!1)}),this.tagInput.autocomplete("widget").addClass("tagit-autocomplete")}},destroy:function(){return t.Widget.prototype.destroy.call(this),this.element.unbind(".tagit"),this.tagList.unbind(".tagit"),this.tagInput.removeData("autocomplete-open"),this.tagList.removeClass(["tagit","ui-widget","ui-widget-content","ui-corner-all","tagit-hidden-field"].join(" ")),this.element.is("input")?(this.element.removeClass("tagit-hidden-field"),this.tagList.remove()):(this.element.children("li").each(function(){t(this).hasClass("tagit-new")?t(this).remove():(t(this).removeClass(["tagit-choice","ui-widget-content","ui-state-default","ui-state-highlight","ui-corner-all","remove","tagit-choice-editable","tagit-choice-read-only"].join(" ")),t(this).text(t(this).children(".tagit-label").text()))}),this.singleFieldNode&&this.singleFieldNode.remove()),this},_cleanedInput:function(){return t.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_cleanedItemValue:function(){return this.tagInput.data("item_value")},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var e=this,i=[];return this.options.singleField?(i=t(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===i[0]&&(i=[])):this._tags().each(function(){i.push(e.tagLabel(this))}),i},_updateSingleTagsField:function(e){t(this.options.singleFieldNode).val(e.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(e,i){for(var a=[],s=0;s<e.length;s++)-1==t.inArray(e[s],i)&&a.push(e[s]);return a},tagLabel:function(e){return t(e).find(".tagit-label:first").text()},tagValue:function(e){var i=this,a=i._formatStr(i.tagLabel(e)),s=null;return this.options.singleField?(values=t(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),t(values).each(function(){var e=t.trim(this.split(":")[1]);return e==a?(s=t.trim(this.split(":")[0]),!1):void 0})):s=t(e).find("input:first").val().split(":")[0],s},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByValue:function(e){var i=this,a=null;return this._tags().each(function(){return i._formatStr(e)==i._formatStr(i.tagValue(this))?(a=t(this),!1):void 0}),a},_isNew:function(t){return!this._findTagByValue(t)},_formatStr:function(e){return this.options.caseSensitive?e:t.trim(e.toLowerCase())},_effectExists:function(e){return Boolean(t.effects&&(t.effects[e]||t.effects.effect&&t.effects.effect[e]))},createTag:function(e,i,a,s){var n=this;if(e=t.trim(e),this.options.preprocessTag&&(e=this.options.preprocessTag(e)),""===e)return!1;if(!this.options.allowDuplicates&&!this._isNew(e)){var o=this._findTagByValue(e);return this._trigger("onTagExists",null,{existingTag:o,duringInitialization:s})!==!1&&this._effectExists("highlight")&&o.effect("highlight"),!1}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger("onTagLimitExceeded",null,{duringInitialization:s}),!1;var l=t(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(i),u=t("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(a).append(l);if(this.options.readOnly)u.addClass("tagit-choice-read-only");else{u.addClass("tagit-choice-editable");var r=t("<span></span>").addClass("ui-icon ui-icon-close"),g=t('<a><span class="text-icon">Ã—</span></a>').addClass("tagit-close").append(r).click(function(){n.removeTag(u)});u.append(g)}if(!this.options.singleField){var h=(l.html(),t.trim(e)+":"+i);u.append('<input type="hidden" value="'+h+'" name="'+this.options.fieldName+'" class="tagit-hidden-field" />')}if(this._trigger("beforeTagAdded",null,{tag:u,tagLabel:this.tagLabel(u),duringInitialization:s})!==!1){if(this.options.singleField){var d=this.assignedTags(),h=t.trim(e)+":"+i;d.push(h),this._updateSingleTagsField(d)}this._trigger("onTagAdded",null,u),this.tagInput.val(""),this.tagInput.parent().before(u),this._trigger("afterTagAdded",null,{tag:u,tagLabel:this.tagLabel(u),duringInitialization:s}),this.options.showAutocompleteOnFocus&&!s&&setTimeout(function(){n._showAutocomplete()},0)}},removeTag:function(e,i){if(i="undefined"==typeof i?this.options.animate:i,e=t(e),this._trigger("onTagRemoved",null,e),this._trigger("beforeTagRemoved",null,{tag:e,tagLabel:this.tagLabel(e)})!==!1){if(this.options.singleField){var a=this.assignedTags(),s=this.tagLabel(e);a=t.grep(a,function(t){var e=t.split(":")[1];return e!=s}),this._updateSingleTagsField(a)}if(i){e.addClass("removed");var n=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"],o=this;n.push(function(){e.remove(),o._trigger("afterTagRemoved",null,{tag:e,tagLabel:o.tagLabel(e)})}),e.fadeOut("fast").hide.apply(e,n).dequeue()}else e.remove(),this._trigger("afterTagRemoved",null,{tag:e,tagLabel:this.tagLabel(e)})}},removeTagByLabel:function(t,e){var i=this._findTagByLabel(t);if(!i)throw"No such tag exists with the name '"+t+"'";this.removeTag(i,e)},removeAll:function(){var t=this;this._tags().each(function(e,i){t.removeTag(i,!1)})}})}(jQuery);
