(function(e){e.widget("ui.tagit",{options:{allowDuplicates:false,caseSensitive:true,fieldName:"tags",placeholderText:null,readOnly:false,removeConfirmation:false,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:false,allowSpaces:false,singleField:false,singleFieldDelimiter:",",singleFieldNode:null,sorteable:false,editable:false,animate:true,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onSortChange:null,onTagClicked:null,onTagLimitExceeded:null,onEditTag:null,onTagAdded:null,onTagRemoved:null,tagSource:null},_create:function(){var t=this;if(this.element.is("input")){this.tagList=e("<ul></ul>").insertAfter(this.element);this.options.singleField=true;this.options.singleFieldNode=this.element;this.element.css("display","none")}else{this.tagList=this.element.find("ul, ol").andSelf().last()}this.tagInput=e('<input type="text" />').addClass("ui-widget-content");if(this.options.readOnly)this.tagInput.attr("disabled","disabled");if(this.options.tabIndex){this.tagInput.attr("tabindex",this.options.tabIndex)}if(this.options.placeholderText){this.tagInput.attr("placeholder",this.options.placeholderText)}if(!this.options.autocomplete.source){this.options.autocomplete.source=function(t,n){var r=t.term.toLowerCase();var i=e.grep(this.options.availableTags,function(e){return e.toLowerCase().indexOf(r)===0});if(!this.options.allowDuplicates){i=this._subtractArray(i,this.assignedTags())}n(i)}}if(this.options.sorteable){var n={items:"li.tagit-choice",delay:150,placeholder:"highlight-sorteable",deactivate:function(){t.onChangeOrder()}};this.tagList.sortable(n)}if(this.options.showAutocompleteOnFocus){this.tagInput.focus(function(e,n){t._showAutocomplete()});if(typeof this.options.autocomplete.minLength==="undefined"){this.options.autocomplete.minLength=0}}if(e.isFunction(this.options.autocomplete.source)){this.options.autocomplete.source=e.proxy(this.options.autocomplete.source,this)}if(e.isFunction(this.options.tagSource)){this.options.tagSource=e.proxy(this.options.tagSource,this)}this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(e('<li class="tagit-new"></li>').append(this.tagInput)).click(function(n){var r=e(n.target);if(r.hasClass("tagit-label")){var i=r.closest(".tagit-choice");if(!i.hasClass("removed")){t._trigger("onTagClicked",n,{tag:i,tagLabel:t.tagLabel(i)})}}else if(!r.hasClass("edit-input")&&!r.hasClass("tagit-edit")&&!r.hasClass("ui-icon")){t.tagInput.focus()}});var r=false;if(this.options.singleField){if(this.options.singleFieldNode){var i=e(this.options.singleFieldNode);var s=i.val().split(this.options.singleFieldDelimiter);i.val("");e.each(s,function(e,n){t.createTag(n,null,true);r=true})}else{this.options.singleFieldNode=e('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />');this.tagList.after(this.options.singleFieldNode)}}if(!r){this.tagList.children("li").each(function(){if(!e(this).hasClass("tagit-new")){t.createTag(e(this).text(),e(this).attr("class"),true);e(this).remove()}})}this.tagInput.keydown(function(n){if(n.which==e.ui.keyCode.BACKSPACE&&t.tagInput.val()===""){var r=t._lastTag();if(!t.options.removeConfirmation||r.hasClass("remove")){t.removeTag(r)}else if(t.options.removeConfirmation){r.addClass("remove ui-state-highlight")}}else if(t.options.removeConfirmation){t._lastTag().removeClass("remove ui-state-highlight")}if(n.which===e.ui.keyCode.COMMA||n.which===e.ui.keyCode.ENTER||n.which==e.ui.keyCode.TAB&&t.tagInput.val()!==""||n.which==e.ui.keyCode.SPACE&&t.options.allowSpaces!==true&&(e.trim(t.tagInput.val()).replace(/^s*/,"").charAt(0)!='"'||e.trim(t.tagInput.val()).charAt(0)=='"'&&e.trim(t.tagInput.val()).charAt(e.trim(t.tagInput.val()).length-1)=='"'&&e.trim(t.tagInput.val()).length-1!==0)){if(!(n.which===e.ui.keyCode.ENTER&&t.tagInput.val()==="")){n.preventDefault()}if(!t.tagInput.data("autocomplete-open")){t.createTag(t._cleanedInput())}}}).blur(function(e){if(!t.tagInput.data("autocomplete-open")){t.createTag(t._cleanedInput())}});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source){var o={select:function(e,n){t.createTag(n.item.value);return false}};e.extend(o,this.options.autocomplete);o.source=this.options.tagSource||o.source;this.tagInput.autocomplete(o).bind("autocompleteopen",function(e,n){t.tagInput.data("autocomplete-open",true)}).bind("autocompleteclose",function(e,n){t.tagInput.data("autocomplete-open",false)})}},_cleanedInput:function(){return e.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var t=this;var n=[];if(this.options.singleField){n=e(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter);if(n[0]===""){n=[]}}else{this._tags().each(function(){n.push(t.tagLabel(this))})}return n},_updateSingleTagsField:function(t){e(this.options.singleFieldNode).val(t.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(t,n){var r=[];for(var i=0;i<t.length;i++){if(e.inArray(t[i],n)==-1){r.push(t[i])}}return r},tagLabel:function(t){if(this.options.singleField){return e(t).find(".tagit-label:first").text()}else{return e(t).find("input:first").val()}},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(t){var n=this;var r=null;this._tags().each(function(i){if(n._formatStr(t)==n._formatStr(n.tagLabel(this))){r=e(this);return false}});return r},_isNew:function(e){return!this._findTagByLabel(e)},_formatStr:function(t){if(this.options.caseSensitive){return t}return e.trim(t.toLowerCase())},_effectExists:function(t){return Boolean(e.effects&&(e.effects[t]||e.effects.effect&&e.effects.effect[t]))},createTag:function(t,n,r){var i=this;t=e.trim(t);if(this.options.preprocessTag){t=this.options.preprocessTag(t)}if(t===""){return false}if(!this.options.allowDuplicates&&!this._isNew(t)){var s=this._findTagByLabel(t);if(this._trigger("onTagExists",null,{existingTag:s,duringInitialization:r})!==false){if(this._effectExists("highlight")){s.effect("highlight")}}return false}if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit){this._trigger("onTagLimitExceeded",null,{duringInitialization:r});return false}var o=e(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(t);var u=e("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(n).append(o);if(!this.options.readOnly&&this.options.editable){var a=e("<input></input>").addClass("edit-input").attr("type","text").hide();u.append(a);var f=e("<span></span>").addClass("ui-icon ui-icon-pencil");var l=e('<a><span class="text-icon">Edit</span></a>').addClass("tagit-edit").append(f).click(function(t){var n=u.children(":first").text();u.children(":first").hide();u.children(".edit-input").show().val(n).focus();u.children(".tagit-save").show();e(this).hide()});u.append(l);var c=e("<span></span>").addClass("ui-icon ui-icon-check");var h=e('<a><span class="text-icon">Save</span></a>').addClass("tagit-edit").addClass("tagit-save").append(c).hide().click(function(t){var n=u.children(":first").text();var r=u.children(".edit-input").show().val();u.children(".edit-input").hide();u.children(":first").text(r);u.children(":first").show();u.children(".tagit-edit").show();e(this).hide();i._tagUpdate();i._trigger("onEditTag",null,{old_tag:n,new_tag:r})});u.append(h)}if(this.options.readOnly){u.addClass("tagit-choice-read-only")}else{u.addClass("tagit-choice-editable");var p=e("<span></span>").addClass("ui-icon ui-icon-close");var d=e('<a><span class="text-icon">Ã—</span></a>').addClass("tagit-close").append(p).click(function(e){i.removeTag(u)});u.append(d)}if(!this.options.singleField){var v=o.html();u.append('<input type="hidden" style="display:none;" value="'+v+'" name="'+this.options.fieldName+'" />')}if(this._trigger("beforeTagAdded",null,{tag:u,tagLabel:this.tagLabel(u),duringInitialization:r})===false){return}if(this.options.singleField){var m=this.assignedTags();m.push(t);this._updateSingleTagsField(m)}this._trigger("onTagAdded",null,u);this.tagInput.val("");this.tagInput.parent().before(u);this._trigger("afterTagAdded",null,{tag:u,tagLabel:this.tagLabel(u),duringInitialization:r});if(this.options.showAutocompleteOnFocus&&!r){setTimeout(function(){i._showAutocomplete()},0)}},onChangeOrder:function(){this._tagUpdate();this._trigger("onSortChange",null)},_tagUpdate:function(){var e=[];var t=this;this._tags().each(function(){e.push(t.tagLabel(this))});this._updateSingleTagsField(e)},removeTag:function(t,n){n=typeof n==="undefined"?this.options.animate:n;t=e(t);this._trigger("onTagRemoved",null,t);if(this._trigger("beforeTagRemoved",null,{tag:t,tagLabel:this.tagLabel(t)})===false){return}if(this.options.singleField){var r=this.assignedTags();var i=this.tagLabel(t);r=e.grep(r,function(e){return e!=i});this._updateSingleTagsField(r)}if(n){t.addClass("removed");var s=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"];var o=this;s.push(function(){t.remove();o._trigger("afterTagRemoved",null,{tag:t,tagLabel:o.tagLabel(t)})});t.fadeOut("fast").hide.apply(t,s).dequeue()}else{t.remove();this._trigger("afterTagRemoved",null,{tag:t,tagLabel:this.tagLabel(t)})}},removeTagByLabel:function(e,t){var n=this._findTagByLabel(e);if(!n){throw"No such tag exists with the name '"+e+"'"}this.removeTag(n,t)},removeAll:function(){var e=this;this._tags().each(function(t,n){e.removeTag(n,false)})}})})(jQuery)